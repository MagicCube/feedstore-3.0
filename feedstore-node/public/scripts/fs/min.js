/* Thu Jun 26 17:06:05 CST 2014 */
/* Generated by MagicCube MXBuild with MXFramework */
$ns("fs");$import("lib.transit.transit");$import("fs.biz.PostAgent");$import("fs.biz.SubscriptionAgent");$import("fs.util.DateTimeUtil");$import("fs.view.CateogryListView");$import("fs.view.PostListView");$import("fs.view.PostDetailView");
fs.App=function(){function c(){a.postDetailView=new fs.view.PostDetailView({id:"postDetail",onshow:function(){a.showOverlay()},onhide:function(){a.hideOverlay()}})}function d(c){a.postDetailView.showPost(c.post)}var a=$extend(mx.app.Application);a.appId="fs.App";a.appDisplayName="MagicCube FeedStore";var h={};a.subscriptionAgent=null;a.postAgent=null;a.categoryListView=null;a.postListView=null;var e=a.postDetailView=null;h.init=a.init;a.init=function(e){h.init(e);a.css({position:"absolute"});a.subscriptionAgent=
new fs.biz.SubscriptionAgent;a.postAgent=new fs.biz.PostAgent;a.categoryListView=new fs.view.CateogryListView({id:"categoryList",frame:{right:12}});a.addSubview(a.categoryListView,a.$container.find("#header"));a.postListView=new fs.view.PostListView({id:"postList",frame:{left:0,top:0,right:0,bottom:0},onpostclick:d});a.postListView.css({paddingTop:62+(window.navigator.standalone?20:0)});a.addSubview(a.postListView);c()};h.run=a.run;a.run=function(c){a.subscriptionAgent.load().done(function(){a.postListView.load()})};
a.getServiceUrl=function(a){return $mappath("~/api"+a)};a.showOverlay=function(){null===e&&(e=$("\x3cdiv id\x3doverlay\x3e"),e.on("click",a.hideOverlay));e.css("opacity",0);$(document.body).css({overflow:"hidden"}).append(e);e.transit({opacity:1},100);1280<=window.innerWidth&&1920>=window.innerWidth&&a.$container.transit({scale:0.9})};a.hideOverlay=function(){$(document.body).css({overflow:"auto"});e.transit({opacity:0},"fast",function(){e.detach()},"fast");1280<=window.innerWidth&&1920>=window.innerWidth&&
a.$container.transit({scale:1})};return a.endOfClass(arguments)};fs.App.className="fs.App";$ns("fs.biz");fs.biz.PostAgent=function(){var c=$extend(MXComponent),d={};d.init=c.init;c.init=function(a){d.init(a)};c.queryPosts=function(a){a=$.extend({pageIndex:0,pageSize:50},a);return $.ajax({url:fs.app.getServiceUrl("/posts/"),data:a})};return c.endOfClass(arguments)};fs.biz.PostAgent.className="fs.biz.PostAgent";$ns("fs.biz");fs.biz.SubscriptionAgent=function(){var c=$extend(MXComponent),d={};c.channels=[];d.init=c.init;c.init=function(a){d.init(a)};c.addChannel=function(a){c.channels.add(a);c.channels[a._id]=a;c.channels[a.cid]=a};c.load=function(){var a=$.Deferred();$.ajax({url:fs.app.getServiceUrl("/subscriptions/")}).done(function(d){d.forEach(function(a){c.addChannel(a)});a.resolve()});return a};return c.endOfClass(arguments)};fs.biz.SubscriptionAgent.className="fs.biz.SubscriptionAgent";$ns("fs.util");fs.util.DateTimeUtilClass=function(){var c=$extend(MXObject);c.parseServerTime=function(c){return new Date(c)};c.getShortString=function(c){var a=Date.now();return c>a-6E4?"\u521a\u521a":c>a-36E5?Math.round((a-c)/1E3/60)+" \u5206\u949f\u524d":c>a-864E5?Math.round((a-c)/1E3/60/60)+" \u5c0f\u65f6\u524d":c>a-1728E5?"\u6628\u5929":c>a-2592E5?"\u524d\u5929":$format(c,"M\u6708d\u65e5")};return c.endOfClass(arguments)};fs.util.DateTimeUtil=new fs.util.DateTimeUtilClass;
fs.util.DateTimeUtilClass.className="fs.util.DateTimeUtilClass";$ns("fs.view");$include("fs.res.CateogryListView.css");fs.view.CateogryListView=function(){var c=$extend(mx.view.View);c.elementClass="CateogryListView";var d={};d.init=c.init;c.init=function(a){d.init(a);c.$container.append("\x3cul\x3e\x3cli\x3e\u5168\u90e8\x3c/li\x3e\x3cli\x3e\u79d1\u6280\x3c/li\x3e\x3cli\x3e\u8bbe\u8ba1\x3c/li\x3e\x3cli\x3e\u8d2d\u7269\x3c/li\x3e\x3c/ul\x3e")};return c.endOfClass(arguments)};fs.view.CateogryListView.className="fs.view.CateogryListView";$ns("fs.view");$include("fs.res.PostDetailView.css");
fs.view.PostDetailView=function(){function c(){var a=$("\x3cdiv id\x3dpost\x3e"),c=$("\x3cdiv id\x3dheader\x3e");c.append("\x3ch1\x3e");c.append("\x3chr\x3e");c.append("\x3cdiv id\x3dpublishTime\x3e");c.append("\x3cdiv id\x3dchannel\x3e");a.append(c);a.append("\x3cdiv id\x3dcontent\x3e");return a}function d(b){b.target===a.$container[0]&&a.hide()}var a=$extend(mx.view.View);a.elementClass="PostDetailView";var h={};a.post=null;a.onshow=null;var e=a.onhide=null,l=null;h.init=a.init;a.init=function(b){h.init(b);
e=c();a.$container.append(e);l=c();l.css({x:1E3});a.$container.on("click",d)};a.setPost=function(b){a.post=b;var c=e;c.find("h1").text(b.title);c.find("#content").html(b.content);c.find("#content").find("a").attr("target","_blank");c.find("#channel").text(fs.app.subscriptionAgent.channels[b.cid].title);c.find("#publishTime").text($format(b.publishTime,"M\u6708d\u65e5 HH:mm"))};a.showPost=function(b){a.setPost(b);a.show()};a.show=function(){a.trigger("show");a.setFrame({top:0,bottom:0,left:0,right:0});
a.css({scale:1,position:"fixed",zIndex:999,opacity:0,y:400});$(document.body).append(a.$container);a.$container.transit({opacity:1,y:0},"fast")};a.hide=function(){a.trigger("hide");a.$container.transit({opacity:0},"fast",function(){a.$container.detach()})};return a.endOfClass(arguments)};fs.view.PostDetailView.className="fs.view.PostDetailView";$ns("fs.view");$include("fs.res.PostListView.css");
fs.view.PostListView=function(){function c(){b.loading||(b.loading=isEmpty(void 0)?!0:!1,fs.app.postAgent.queryPosts({pageIndex:b.pageIndex,pageSize:b.pageSize}).done(function(a){b.loading=isEmpty(!1)?!0:!1;b.addPosts(a);b.pageIndex++}))}function d(){if(!(null===k||0===k.length)){var a=b.$container[0].scrollTop+document.body.offsetHeight,d=k.reduce(function(a,b){return isEmpty(a)||a>b.height()?b.height():a},Number.MAX_VALUE);a>d+20&&c()}}function a(a){b.frame.height=b.$container.height();b.frame.width!==
b.$container.width()&&(b.frame.width=b.$container.width(),b.resetCols(),d())}function h(a){d()}function e(a){a=$(a.currentTarget).parent();var c=a.data("post");b.trigger("postclick",{post:c,$post:a})}function l(a){a.target.src=b.getResourcePath("images.post-thumb-placeholder","png")}var b=$extend(mx.view.View);b.elementClass="PostListView";b.frame={};var m={};b.posts=[];b.cols=0;b.colIndex=0;b.pageIndex=0;b.pageSize=50;b.colSpace=12;b.onpostclick=null;var k=[],f=null;m.init=b.init;b.init=function(c){m.init(c);
b.$container.on("click",".post \x3e #thumb, .post \x3e #title",e);b.$container.on("scroll",h);$(window).on("resize",a)};b.load=function(){a();b.clear();c()};b.resetCols=function(){var a=Math.floor(b.frame.width/(224+b.colSpace));6<a&&(a=6);if(b.cols!==a){null===f&&(f=$("\x3cdiv class\x3dcolgroup\x3e"),b.$container.append(f));k.clear();b.cols=a;f.find(".col").remove();for(a=0;a<b.cols;a++){var c=$("\x3cdiv class\x3dcol/\x3e");f.append(c);k.add(c);a!=b.cols-1&&c.css({marginRight:b.colSpace})}f.css({width:(224+
b.colSpace)*b.cols-b.colSpace});b.colIndex=0;f.find(".post").remove();a=b.posts.clone();b.posts.clear();b.addPosts(a)}};b.addPost=function(a){isString(a.publishTime)&&(a.publishTime=fs.util.DateTimeUtil.parseServerTime(a.publishTime));b.posts.add(a);b.colIndex==b.cols&&(b.colIndex=0);var c=k[b.colIndex],d=fs.app.subscriptionAgent.channels[a.cid],e=$("\x3cdiv class\x3dpost\x3e");e.data("post",a);e.attr("id",a._id);var g=$("\x3cimg id\x3dthumb\x3e");g.on("error",l);g.attr({src:notEmpty(a.image)?a.image.url:
b.getResourcePath("images.post-thumb-placeholder","png")});e.append(g);g=$("\x3cdiv id\x3dtitle\x3e");g.text(a.title);e.append(g);b.$container.append(e);var g=$("\x3cdiv id\x3dinfo\x3e"),f=$("\x3ca id\x3dchannel\x3e");f.text(d.title);f.attr("title",d.title);g.append(f);d=$("\x3cdiv id\x3dtime\x3e");d.text(fs.util.DateTimeUtil.getShortString(a.publishTime));d.attr("title",a.publishTime.toLocaleString());g.append(d);e.append(g);c.append(e);b.colIndex++};b.addPosts=function(a){a.forEach(function(a){b.addPost(a)})};
b.setPosts=function(a){b.clear();b.addPosts(a)};b.clear=function(a){b.pageIndex=0;b.colIndex=0;null!==f&&f.find(".post").remove();b.posts.clear()};return b.endOfClass(arguments)};fs.view.PostListView.className="fs.view.PostListView";