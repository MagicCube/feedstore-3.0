/* Fri Jun 20 08:47:00 CST 2014 */
/* Generated by MagicCube MXBuild with MXFramework */
$ns("fs");$import("fs.biz.PostAgent");$import("fs.biz.SubscriptionAgent");$import("fs.view.PostListView");
fs.App=function(){var b=$extend(mx.app.Application);b.appId="fs.App";b.appDisplayName="MagicCube FeedStore";var c={};b.subscriptionAgent=null;b.postAgent=null;b.postListView=null;c.init=b.init;b.init=function(a){c.init(a);b.subscriptionAgent=new fs.biz.SubscriptionAgent;b.postAgent=new fs.biz.PostAgent;b.postListView=new fs.view.PostListView({frame:{top:0,bottom:0,left:0,right:0}});b.postListView.css({marginTop:62});b.addSubview(b.postListView)};c.run=b.run;b.run=function(a){b.subscriptionAgent.load().done(function(){b.postListView.load()})};
b.getServiceUrl=function(a){return $mappath("~/api"+a)};return b.endOfClass(arguments)};fs.App.className="fs.App";$ns("fs.biz");fs.biz.PostAgent=function(){var b=$extend(MXComponent),c={};c.init=b.init;b.init=function(a){c.init(a)};b.queryPosts=function(a){a=$.extend({pageIndex:0,pageSize:50},a);return $.ajax({url:fs.app.getServiceUrl("/posts/"),data:a})};return b.endOfClass(arguments)};fs.biz.PostAgent.className="fs.biz.PostAgent";$ns("fs.biz");fs.biz.SubscriptionAgent=function(){var b=$extend(MXComponent),c={};b.channels=[];c.init=b.init;b.init=function(a){c.init(a)};b.addChannel=function(a){b.channels.add(a);b.channels[a._id]=a;b.channels[a.cid]=a};b.load=function(){var a=$.Deferred();$.ajax({url:fs.app.getServiceUrl("/subscriptions/")}).done(function(c){c.forEach(function(a){b.addChannel(a)});a.resolve()});return a};return b.endOfClass(arguments)};fs.biz.SubscriptionAgent.className="fs.biz.SubscriptionAgent";$ns("fs.view");$include("fs.res.PostListView.css");
fs.view.PostListView=function(){function b(){a.pageIndex++;fs.app.postAgent.queryPosts({pageIndex:a.pageIndex,pageSize:a.pageSize}).done(function(b){a.addPosts(b)})}function c(){a.frame.height=a.$container.height();if(a.frame.width!==a.$container.width()){a.frame.width=a.$container.width();null===d&&(d=$("\x3cdiv class\x3dcolgroup\x3e"),a.$container.append(d));var b=Math.floor(a.frame.width/236);if(a.cols!==b){g.clear();a.cols=b;d.find(".col").remove();for(b=0;b<a.cols;b++){var c=$("\x3cdiv class\x3dcol/\x3e");
d.append(c);g.add(c);b!=a.cols-1&&c.css({marginRight:12})}d.css({width:236*a.cols-12});a.colIndex=-1;d.find(".post").remove();b=a.posts.clone();a.posts.clear();a.addPosts(b)}}}var a=$extend(mx.view.View);a.elementClass="PostListView";var k={};a.posts=[];a.cols=0;a.colIndex=0;a.pageIndex=0;a.pageSize=50;var g=[],d=null;k.init=a.init;a.init=function(a){k.init(a)};a.load=function(){a.clear();c();b()};a.addPost=function(b){isString(b.publishTime)&&(b.publishTime=new Date(b.publishTime));a.posts.add(b);
a.colIndex++;a.colIndex==a.cols&&(a.colIndex=0);var c=g[a.colIndex],d=fs.app.subscriptionAgent.channels[b.cid],f=$("\x3cdiv class\x3dpost\x3e");f.attr("id",b._id);var e=$("\x3cdiv id\x3dthumb\x3e");f.append(e);e=$("\x3cdiv id\x3dtitle\x3e");e.text(b.title);f.append(e);a.$container.append(f);var e=$("\x3cdiv id\x3dinfo\x3e"),h=$("\x3ca id\x3dchannel\x3e");h.text(d.title);h.attr("title",d.title);e.append(h);d=$("\x3cdiv id\x3dtime\x3e");b.publishTime>=Date.today?d.text($format(b.publishTime,"HH:mm")):
d.text($format(b.publishTime,"M\u6708d\u65e5"));e.append(d);f.append(e);c.append(f)};a.addPosts=function(b){b.forEach(function(b){a.addPost(b)})};a.setPosts=function(b){a.clear();a.addPosts(b)};a.clear=function(b){a.pageIndex=-1;a.colIndex=-1;null!=d&&d.find(".post").remove();a.posts.clear()};$(window).on("resize",c);return a.endOfClass(arguments)};fs.view.PostListView.className="fs.view.PostListView";